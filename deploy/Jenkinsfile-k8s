pipeline {
  agent any
  environment {
      CI = false
  }
  stages {
    stage('git pull') {
      steps {
        git url: 'https://sjkim_emotion@bitbucket.org/emgglobal/smart-city-challenge.git', 
            branch: 'prod', 
            credentialsId: 'b07620dd-74f5-486d-bba7-c671cfbb3825'
      }
    }
    stage ('frontend build') {
      tools { nodejs "NodeJS16" }
      steps {
        sh 'cd monitor/frontend && rm -rf build && npm install && npm run build:nextdev'
      }
    }
    stage ('backend build') {
      steps {
        sh 'cd backend && ./gradlew clean build'
      }
    }
    stage('docker build and push'){
      steps {
        sh './challenge-docker-build-push.sh'
      }
    }
    stage('kubernetes deploy over ssh') {
      steps([$class: 'BapSshPromotionPublisherPlugin']) {
        sshPublisher(
          continueOnError: false,
          failOnError: true,
          publishers: [
            sshPublisherDesc(
              configName: 'k8s HA lb',
              verbose: true,
              transfers: [
                sshTransfer(
                    sourceFiles: 'deploy/challenge-k8s-deploy/**',
                    removePrefix: 'deploy/challenge-k8s-deploy/',
                    remoteDirectory: 'smart-city-challenge/deploy',
                    execCommand: 'kubectl delete -k smart-city-challenge/deploy; \
                                  kubectl apply -k smart-city-challenge/deploy'
                )
              ]
            )
          ]
        )
      }
    }
  }
  post {
    failure {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS',
                 attachLog: true
    }
    success {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS'
    }
    unstable {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS',
                 attachLog: true
    }
  }
}
