pipeline {
  agent any
  environment {
      CI = false
  }
  stages {
    stage('git pull') {
      steps {
        git url: 'https://sjkim_emotion@bitbucket.org/emgglobal/smart-city-challenge.git', 
            branch: 'prod',
            credentialsId: 'b07620dd-74f5-486d-bba7-c671cfbb3825'
      }
    }
    stage ('frontend build') {
      tools { nodejs "NodeJS16" }
      steps {
        sh 'cd frontend && rm -rf build && npm install && npm run build:prod'
      }
    }
    stage ('backend build') {
      steps {
        sh 'cd backend && ./gradlew clean build'
      }
    }
    stage('docker build and push'){
      steps {
        sh 'cd deploy && ./challenge-docker-build-push.sh'
      }
    }
    stage('kubernetes deploy over ssh') {
      steps([$class: 'BapSshPromotionPublisherPlugin']) {
        sshPublisher(
          continueOnError: false,
          failOnError: true,
          publishers: [
            sshPublisherDesc(
              configName: 'SmartCityChallenge',
              verbose: true,
              transfers: [
                sshTransfer(
                    sourceFiles: 'deploy/challenge-k8s-prod/*',
                    removePrefix: 'deploy/challenge-k8s-prod/',
                    remoteDirectory: 'smart-city-challenge/deploy',
                    execCommand: 'export KUBECONFIG=/etc/kubernetes/admin.conf; \
                                  chown $(id -u):$(id -g) /etc/kubernetes/admin.conf; \
                                  cd smart-city-challenge/deploy && chmod 755 *.sh; \
                                  ./challenge-stop.sh; \
                                  ./challenge-start.sh;'
                )
              ]
            )
          ]
        )
      }
    }
  }
  post {
    failure {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS',
                 attachLog: true
    }
    success {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS'
    }
    unstable {
        emailext subject: '$DEFAULT_SUBJECT',
                 body: '$DEFAULT_CONTENT',
                 to: '$DEFAULT_RECIPIENTS',
                 attachLog: true
    }
  }
}
